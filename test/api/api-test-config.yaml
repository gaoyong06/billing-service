config:
  baseUrl: "http://localhost:8107"
  variables:
    userId: "user_test_001"
    serviceName: "passport"
  apiSpec: "/Users/gaoyong/Documents/work/xinyuan_tech/billing-service/api/billing/v1/billing.proto"

tests:
  # 1. 初始状态检查
  - name: "1. Get Account - Initial State"
    path: "/api/v1/billing/account"
    method: "GET"
    params:
      user_id: "${userId}"
    expect:
      status: 200
      body:
        user_id: "${userId}"
        balance: 0

  # 2. 充值流程
  - name: "2. Recharge Account"
    path: "/api/v1/billing/recharge"
    method: "POST"
    body:
      user_id: "${userId}"
      amount: 100.0
      payment_method: "wechat"
    expect:
      status: 200
      body:
        payment_url: "contains:https://"
    extract:
      orderId: "order_id"

  # 注意：由于充值回调是 Internal 接口，且通常通过 gRPC 调用，
  # HTTP API 测试无法直接触发回调来增加余额。
  # 在集成测试环境中，我们需要一个 Helper 接口或者直接操作 DB 来模拟充值成功。
  # 或者，如果 Internal Service 开启了 HTTP Transcoding，我们可以尝试调用。
  # 假设 Internal 接口未暴露 HTTP，这里的测试主要验证 Public API 的契约。

  # 3. 查询流水 (初始为空)
  - name: "3. List Records - Empty"
    path: "/api/v1/billing/records"
    method: "GET"
    params:
      user_id: "${userId}"
      page: 1
      page_size: 10
    expect:
      status: 200
      body:
        total: 0

  # 4. 再次查询账户 (验证充值链接生成不影响余额)
  - name: "4. Get Account - After Recharge Request"
    path: "/api/v1/billing/account"
    method: "GET"
    params:
      user_id: "${userId}"
    expect:
      status: 200
      body:
        balance: 0
