# Billing Serviceï¼ˆè®¡è´¹æœåŠ¡ï¼‰

- èŒè´£ï¼šè´¢åŠ¡ä¸­å¿ƒï¼Œç®¡ç†ç”¨æˆ·èµ„äº§å’Œæ‰£è´¹
- è´Ÿè´£ï¼š
 - ä½™é¢ç®¡ç†ï¼ˆuser_balance è¡¨ï¼‰
 - å…è´¹é¢åº¦ç®¡ç†ï¼ˆfree_quota è¡¨ï¼‰
 - æ‰£è´¹é€»è¾‘ï¼ˆä¼˜å…ˆå…è´¹é¢åº¦ï¼Œä¸è¶³æ‰£ä½™é¢ï¼‰
 - æ¶ˆè´¹æµæ°´ï¼ˆbilling_record è¡¨ï¼‰
 - å……å€¼è®¢å•ï¼ˆrecharge_order è¡¨ï¼‰
 - æ•°æ®ï¼šè®°å½•â€œæ¶ˆè´¹æµæ°´â€ï¼ˆç”¨æˆ·ä½¿ç”¨æœåŠ¡æ—¶çš„æ‰£è´¹ï¼‰

DevShare å¹³å°çš„è´¢åŠ¡ä¸­å¿ƒï¼Œè´Ÿè´£ç®¡ç†å¼€å‘è€…çš„é’±åŒ…ã€é…é¢ä¸è´¦å•ã€‚

## åŠŸèƒ½ç‰¹æ€§

- **èµ„äº§ç®¡ç†**ï¼šæ”¯æŒå…è´¹é¢åº¦å’Œä½™é¢é’±åŒ…çš„æ··åˆæ”¯ä»˜æ¨¡å¼
- **é…é¢ç®¡ç†**ï¼šè‡ªåŠ¨ç®¡ç†æ¯æœˆå…è´¹é¢åº¦ï¼Œæ”¯æŒè‡ªåŠ¨é‡ç½®
- **æ‰£è´¹é€»è¾‘**ï¼šä¼˜å…ˆæ‰£é™¤å…è´¹é¢åº¦ï¼Œä¸è¶³æ—¶æ‰£é™¤ä½™é¢ï¼Œæ”¯æŒæ··åˆæ‰£è´¹
- **è´¦å•è®°å½•**ï¼šè®°å½•æ¯ä¸€ç¬” API è°ƒç”¨çš„æ‰£è´¹æƒ…å†µ
- **æ€§èƒ½ä¼˜åŒ–**ï¼šä½¿ç”¨ Redis ç¼“å­˜ä¼˜åŒ–é…é¢æ£€æŸ¥å’Œä½™é¢æŸ¥è¯¢



## ğŸ“Š é›†æˆæ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     Billing Service                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”‚
â”‚  â”‚ BillingUseCaseâ”‚â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚PaymentClient â”‚                  â”‚
â”‚  â”‚   (Biz Layer) â”‚         â”‚  (Interface) â”‚                  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â”‚
â”‚         â”‚                         â”‚                           â”‚
â”‚         â”‚                         â–¼                           â”‚
â”‚         â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”‚
â”‚         â”‚              â”‚PaymentClientAdapterâ”‚                 â”‚
â”‚         â”‚              â”‚  (Adapter Layer)  â”‚                  â”‚
â”‚         â”‚              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â”‚
â”‚         â”‚                         â”‚                           â”‚
â”‚         â”‚                         â–¼                           â”‚
â”‚         â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
â”‚         â”‚              â”‚PaymentServiceClient  â”‚              â”‚
â”‚         â”‚              â”‚   (Data Layer)       â”‚              â”‚
â”‚         â”‚              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
â”‚         â”‚                         â”‚                           â”‚
â”‚         â”‚                         â”‚ gRPC                      â”‚
â”‚         â”‚                         â–¼                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚                         â”‚
          â”‚                         â”‚
          â–¼                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Payment Service                           â”‚
â”‚                   (port: 9101)                               â”‚
â”‚                                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  CreatePayment(order_id, user_id, amount, ...)       â”‚  â”‚
â”‚  â”‚  Returns: payment_id, pay_url, status                â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”„ å……å€¼æµç¨‹

### å®Œæ•´æµç¨‹å›¾

```
ç”¨æˆ·å‘èµ·å……å€¼
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. BillingService.Recharge(user_id, amount, method)     â”‚
â”‚    - ç”Ÿæˆè®¢å•ID: recharge_{user_id}_{timestamp}        â”‚
â”‚    - åˆ›å»ºå……å€¼è®¢å•è®°å½•ï¼ˆrecharge_order è¡¨ï¼‰              â”‚
â”‚    - çŠ¶æ€: pending                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. PaymentClient.CreatePayment()                        â”‚
â”‚    - è°ƒç”¨ payment-service gRPC æ¥å£                     â”‚
â”‚    - å‚æ•°è½¬æ¢: amount(å…ƒâ†’åˆ†), user_id(stringâ†’uint64)   â”‚
â”‚    - ä¼ é€’: order_id, method, subject, return_url, etc. â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. Payment Service å¤„ç†                                  â”‚
â”‚    - ç”Ÿæˆ payment_id                                     â”‚
â”‚    - è°ƒç”¨ç¬¬ä¸‰æ–¹æ”¯ä»˜ï¼ˆæ”¯ä»˜å®/å¾®ä¿¡/Stripeï¼‰               â”‚
â”‚    - è¿”å›: payment_id, pay_url, status                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4. è¿”å›æ”¯ä»˜é“¾æ¥ç»™å‰ç«¯                                    â”‚
â”‚    - order_id: recharge_xxx                              â”‚
â”‚    - pay_url: https://payment.xxx/...                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚
    â–¼
ç”¨æˆ·å®Œæˆæ”¯ä»˜
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 5. Payment Service å›è°ƒ Billing Service                 â”‚
â”‚    POST /internal/v1/billing/callback                    â”‚
â”‚    - payment_order_id                                    â”‚
â”‚    - amount                                              â”‚
â”‚    - status: SUCCESS                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 6. RechargeCallback å¤„ç†ï¼ˆå¹‚ç­‰æ€§ä¿è¯ï¼‰                   â”‚
â”‚    - æŸ¥è¯¢ recharge_orderï¼ˆé€šè¿‡ payment_order_idï¼‰       â”‚
â”‚    - æ£€æŸ¥çŠ¶æ€ï¼ˆå¦‚æœå·² successï¼Œç›´æ¥è¿”å›ï¼‰               â”‚
â”‚    - åœ¨äº‹åŠ¡ä¸­ï¼š                                          â”‚
â”‚      a. æ›´æ–°è®¢å•çŠ¶æ€ä¸º success                           â”‚
â”‚      b. å¢åŠ ç”¨æˆ·ä½™é¢                                     â”‚
â”‚      c. æ›´æ–° Redis ç¼“å­˜                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚
    â–¼
å……å€¼å®Œæˆ âœ…
```

## æŠ€æœ¯æ ˆ

- **æ¡†æ¶**ï¼šKratos v2
- **æ•°æ®åº“**ï¼šMySQL (GORM)
- **ç¼“å­˜**ï¼šRedis
- **åè®®**ï¼šgRPC + HTTP

## å¿«é€Ÿå¼€å§‹

### 1. åˆå§‹åŒ–æ•°æ®åº“

æ‰§è¡Œ SQL è„šæœ¬åˆ›å»ºæ•°æ®åº“è¡¨ï¼š

```bash
mysql -u root -p < docs/sql/billing_service.sql
```

### 2. ç”Ÿæˆ Proto ä»£ç 

```bash
make init
```

### 3. é…ç½®æœåŠ¡

ä¿®æ”¹ `configs/config.yaml` ä¸­çš„æ•°æ®åº“å’Œ Redis è¿æ¥ä¿¡æ¯ã€‚

### 4. è¿è¡ŒæœåŠ¡

```bash
make run
```

æˆ–è€…ï¼š

```bash
go run ./cmd/billing-service/main.go -conf ./configs/config.yaml
```

## é¡¹ç›®ç»“æ„

```
billing-service/
â”œâ”€â”€ api/                    # API å®šä¹‰ (proto æ–‡ä»¶)
â”‚   â””â”€â”€ billing/v1/
â”œâ”€â”€ cmd/                    # å…¥å£æ–‡ä»¶
â”‚   â”œâ”€â”€ server/            # ä¸»æœåŠ¡å…¥å£
â”‚   â””â”€â”€ cron/              # Cron å®šæ—¶ä»»åŠ¡æœåŠ¡å…¥å£
â”œâ”€â”€ configs/                # é…ç½®æ–‡ä»¶
â”œâ”€â”€ docs/                   # è®¾è®¡æ–‡æ¡£
â”œâ”€â”€ internal/               # å†…éƒ¨ä»£ç 
â”‚   â”œâ”€â”€ biz/               # ä¸šåŠ¡é€»è¾‘å±‚
â”‚   â”œâ”€â”€ data/              # æ•°æ®è®¿é—®å±‚
â”‚   â”œâ”€â”€ service/           # æœåŠ¡å±‚ (gRPC å®ç°)
â”‚   â”œâ”€â”€ server/            # æœåŠ¡å™¨é…ç½®
â”‚   â””â”€â”€ conf/              # é…ç½®ç»“æ„
â””â”€â”€ README.md
```

## API æ¥å£

### ç®¡ç†æ¥å£ (é¢å‘å‰ç«¯/å¼€å‘è€…)

- `GET /api/v1/billing/account` - è·å–è´¦æˆ·èµ„äº§ä¿¡æ¯
- `POST /api/v1/billing/recharge` - å‘èµ·å……å€¼
- `GET /api/v1/billing/records` - è·å–æ¶ˆè´¹æµæ°´

### å†…éƒ¨æ¥å£ (é¢å‘ Gateway/Payment)

- `CheckQuota` - æ£€æŸ¥é…é¢
- `DeductQuota` - æ‰£å‡é…é¢
- `RechargeCallback` - å……å€¼å›è°ƒ

## è®¾è®¡æ–‡æ¡£

è¯¦ç»†çš„è®¾è®¡æ–‡æ¡£è¯·å‚è€ƒ `docs/` ç›®å½•ï¼š

- `product-demand.md` - äº§å“éœ€æ±‚æ–‡æ¡£
- `service-spec.md` - æŠ€æœ¯è®¾è®¡æ–‡æ¡£
- `logic_design.md` - ä¸šåŠ¡é€»è¾‘è®¾è®¡
- `sql/billing_service.sql` - æ•°æ®åº“è®¾è®¡

## Cron å®šæ—¶ä»»åŠ¡æœåŠ¡

Billing Service åŒ…å«ä¸€ä¸ªç‹¬ç«‹çš„ Cron æœåŠ¡ï¼Œç”¨äºæ‰§è¡Œå®šæ—¶ä»»åŠ¡ã€‚

### å®šæ—¶ä»»åŠ¡

| ä»»åŠ¡åç§° | Cron è¡¨è¾¾å¼ | æ‰§è¡Œæ—¶é—´ | åŠŸèƒ½æè¿° |
|---------|------------|---------|---------|
| å…è´¹é¢åº¦é‡ç½® | `0 0 0 1 * *` | æ¯æœˆ1æ—¥ 00:00 | ä¸ºæ‰€æœ‰ç”¨æˆ·åˆ›å»ºä¸‹ä¸ªæœˆçš„å…è´¹é¢åº¦è®°å½• |

### Cron æœåŠ¡å¯åŠ¨

```bash
# ç¼–è¯‘ Cron æœåŠ¡
make build-cron

# å¯åŠ¨ Cron æœåŠ¡
make run-cron

# æˆ–è€…ç›´æ¥è¿è¡Œ
./bin/cron -conf ./configs/config.yaml
```

### åŒæ—¶è¿è¡Œä¸»æœåŠ¡å’Œ Cron æœåŠ¡

```bash
# å¯åŠ¨æ‰€æœ‰æœåŠ¡ï¼ˆcron åå°ï¼Œserver å‰å°ï¼‰
make run-all

# åœæ­¢æ‰€æœ‰æœåŠ¡
make stop-all
```

### æ—¥å¿—

Cron æœåŠ¡çš„æ—¥å¿—ä¼šè¾“å‡ºåˆ°æ ‡å‡†è¾“å‡ºï¼Œå¦‚æœä½¿ç”¨ `make run-all`ï¼Œæ—¥å¿—ä¼šä¿å­˜åˆ° `logs/cron.log`ã€‚

## License

MIT
